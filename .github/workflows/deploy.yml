name: Build and Deploy

on:
  release:
    types: [published]
  workflow_dispatch:  # Ручной запуск

jobs:
  build:
    name: Build Artifact
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Get version
      id: version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: qa-simulator-${{ steps.version.outputs.version }}
        path: target/*.jar

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/qa-simulator:latest
          ${{ secrets.DOCKER_USERNAME }}/qa-simulator:${{ github.sha }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: docker-build
    environment: staging

    steps:
    - name: Deploy to Kubernetes
      uses: steebchen/kubectl@v2
      with:
        config: ${{ secrets.KUBE_CONFIG_STAGING }}
        command: |
          set -x
          kubectl set image deployment/qa-simulator qa-simulator=${{ secrets.DOCKER_USERNAME }}/qa-simulator:${{ github.sha }}
          kubectl rollout status deployment/qa-simulator

    - name: Run smoke tests
      run: |
        # Запуск smoke тестов после деплоя
        ./scripts/run-smoke-tests.sh

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
    - name: Approve deployment
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: team-leads
        minimum-approvals: 2

    - name: Deploy to Production
      uses: steebchen/kubectl@v2
      with:
        config: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
        command: |
          kubectl set image deployment/qa-simulator qa-simulator=${{ secrets.DOCKER_USERNAME }}/qa-simulator:${{ github.sha }}
          kubectl rollout status deployment/qa-simulator